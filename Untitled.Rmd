---
title: "Untitled"
author: "Demetri Pananos"
date: "07/12/2021"
output: pdf_document
---


```{r, include=FALSE, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(
  echo = F,
  message = F,
  warning = F,
  fig.height = 4,
  fig.align = 'center',
  dpi = 400,
  cache = T
)


library(tidyverse)
library(rstanarm)
library(tidybayes)
library(cmdstanr)
library(rms)
library(posterior)
theme_set(theme_light())

cmdstanr::register_knitr_engine(override = F)
```

- Linear model usually good (parsimony, availability, first thing you learn).
- When substantive knowledge on conditional mean available (e.g. from separate theory), linear model can be bad.
- Bias (in tmax and consequently cmax).  Just look at the math.
- Underdetermination of effects (does this gene effect the clearance or the bioavaiability?  You know from pharmacological/physiological/biochemical theory, you just don't put that in the model).
- And if taking a frequentest approach, why re-estimate things we regularly publish (tmax, othet stuff)
- I bet you can do just as well (in a predictive sense) while also ameliorating bias and underdetermination.  Maybe this is "doing better" in some sense.

```{r}
d = read_csv('data/cleaned_data.csv')  %>% 
    select(-history_heart_failure)
dd = datadist(d)
options(datadist='dd')

markus_model = ols(log(yobs_ng_ml) ~ dose_mg_twice_daily + hrs_post_dose + sex + age + weight_kg + creatinine_micromol_l + amiodarone_mg_day + diltiazem_mg_day, data = d, x=T, y=T)

extended_model = ols(log(yobs_ng_ml) ~ dose_mg_twice_daily + hrs_post_dose*(sex + age + weight_kg + creatinine_micromol_l) + amiodarone_mg_day + diltiazem_mg_day, data = d, x=T, y=T)


validate(markus_model, B = 500)
validate(extended_model, B = 500)

a = exp(predict(markus_model))
b = exp(predict(extended_model))
```


# Model 1
```{cmdstan, output.var = 'model_001_base'}
functions{
  vector concentration(vector t, vector D, vector F, vector V, vector ka, vector ke){
   return D .* F .* ka ./ (V .* (ke - ka)) .* (exp(-ka .* t) - exp(-ke .* t));
  }
}
data{
//Basic
int n;
vector[n] dose_mg_twice_daily;
vector[n] hrs_post_dose;
vector[n] yobs_ng_ml;

//Clinical
vector[n] age;
vector[n] sex;
vector[n] weight_kg;
vector[n] creatinine_micromol_l;

//History
vector[n] history_arrhythmia_treatments_e_g_ablation_cardioversion;
vector[n] history_diabetes;
vector[n] history_hypertension;
vector[n] history_ischemic_stroke;
vector[n] history_tia;
vector[n] history_hemorrhage;
vector[n] history_myocardial_infarction;
vector[n] history_pci;
vector[n] history_coronary_artery_bypass_graft;
vector[n] history_peripheral_vascular_disease;
vector[n] history_cancer;
vector[n] history_ckd;

//Drug
vector[n] amiodarone_mg_day;
vector[n] carbamazepine_mg_day;
vector[n] diltiazem_mg_day;
vector[n] phenobarbital_mg_day;
vector[n] phenytoin_mg_day;
vector[n] primidone_mg_day;
vector[n] rifampin_mg_day;
vector[n] verapamil_mg_day;
vector[n] ketoconazole_mg_day;
vector[n] fluconazole_mg_day;
}
transformed data{
  vector[n] yobs = yobs_ng_ml * 0.001;
}
parameters{
  real<lower=0> V;
  real<lower=0> ke;
  real<lower=0, upper=1> F;
  real<lower=0, upper=1> a;
  real<lower=0> sigma;
}
transformed parameters{
 real<lower=0> ka= ke/a;
 vector[n] C = concentration(hrs_post_dose, dose_mg_twice_daily, rep_vector(F, n), rep_vector(V, n), rep_vector(ka, n), rep_vector(ke, n));
}
model{
  V ~ normal(21.0, 1.0);
  ke ~ normal(0, 1);
  a ~ beta(2, 2);
  F ~ normal(0.5, 0.05);
  sigma ~ cauchy(0, 1);
  yobs ~ lognormal(log(C), sigma);
}
generated quantities{
  vector[n] yppc = 1000*to_vector(lognormal_rng(log(C), sigma));
  vector[n] Cpred = 1000*C;
}
```


```{cmdstan, output.var = 'model_002_covars'}
functions{
  vector concentration(vector t, vector D, vector F, vector V, vector ka, vector ke){
   return D .* F .* ka ./ (V .* (ke - ka)) .* (exp(-ka .* t) - exp(-ke .* t));
  }
}
data{
//Basic
int n;
vector[n] dose_mg_twice_daily;
vector[n] hrs_post_dose;
vector[n] yobs_ng_ml;

//Clinical
vector[n] age;
vector[n] sex;
vector[n] weight_kg;
vector[n] creatinine_micromol_l;

//History
vector[n] history_arrhythmia_treatments_e_g_ablation_cardioversion;
vector[n] history_diabetes;
vector[n] history_hypertension;
vector[n] history_ischemic_stroke;
vector[n] history_tia;
vector[n] history_hemorrhage;
vector[n] history_myocardial_infarction;
vector[n] history_pci;
vector[n] history_coronary_artery_bypass_graft;
vector[n] history_peripheral_vascular_disease;
vector[n] history_cancer;
vector[n] history_ckd;

//Drug
vector[n] amiodarone_mg_day;
vector[n] carbamazepine_mg_day;
vector[n] diltiazem_mg_day;
vector[n] phenobarbital_mg_day;
vector[n] phenytoin_mg_day;
vector[n] primidone_mg_day;
vector[n] rifampin_mg_day;
vector[n] verapamil_mg_day;
vector[n] ketoconazole_mg_day;
vector[n] fluconazole_mg_day;
}
transformed data{
  vector[n] yobs = yobs_ng_ml * 0.001;
  vector[n] scaled_creatinine = (creatinine_micromol_l - mean(creatinine_micromol_l))/sd(creatinine_micromol_l);
  vector[n] scaled_weight = (weight_kg - mean(weight_kg))/sd(weight_kg);
  
  vector[n] scaled_diltiazem = diltiazem_mg_day/max(diltiazem_mg_day);
  vector[n] scaled_amiodarone = amiodarone_mg_day/max(amiodarone_mg_day);
}
parameters{
  
  real<lower=0> V;
  
  real<lower=0> mu_ke;
  real b_creatinine_ke;
  real b_weight_ke;
  
  
  real mu_F;
  real b_amiodarone_F;
  real b_diltiazem_F;
  
  real<lower=0, upper=1> a;
  real<lower=0> sigma;
}
transformed parameters{
 vector<lower=0, upper=1>[n] F = inv_logit(mu_F + b_amiodarone_F*scaled_amiodarone + b_diltiazem_F*scaled_diltiazem);
 vector<lower=0>[n] ke = mu_ke*exp(b_creatinine_ke*scaled_creatinine + b_weight_ke*scaled_weight);
 vector<lower=0>[n] ka= ke/a;
 vector[n] C = concentration(hrs_post_dose, dose_mg_twice_daily, F, rep_vector(V, n), ka, ke);
}
model{
  V ~ normal(21.0, 1.0);
  
  mu_ke ~ normal(0, 1);
  b_creatinine_ke ~ normal(0, 0.25);
  
  a ~ beta(2, 2);
  
  mu_F ~ normal(0.5, 0.05);
  b_amiodarone_F ~ double_exponential(0, 1);
  b_diltiazem_F ~ double_exponential(0, 1);
  
  sigma ~ cauchy(0, 1);
  yobs ~ lognormal(log(C), sigma);
}
generated quantities{
  vector[n] yppc = 1000*to_vector(lognormal_rng(log(C), sigma));
  vector[n] Cpred = 1000*C;
}
```

```{r}
stan_data = compose_data(d)
fit = model_002_covars$sample(stan_data, chains=4, parallel_chains=4)
fit$cmdstan_diagnose()

ypred = fit$draws('yppc') %>% 
  as_draws_matrix() %>% 
  apply(., 2, mean)

y = d$yobs_ng_ml

plot(log(ypred), log(y/ypred))

MLmetrics::RMSE(ypred/1000, y/1000)



fit$draws('b_creatinine_ke') %>% hist
fit$draws('b_weight_ke') %>% hist
fit$draws('b_diltiazem_F') %>% hist
fit$draws('sigma') %>% hist
fit$draws('V') %>% hist


```

