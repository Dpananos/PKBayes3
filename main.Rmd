---
title: "Paper 3"
author:
  - "A. Demetri Pananos"
  - "Daniel J. Lizotte"
output: pdf_document
date: "`r format(Sys.time(), '%B %d, %Y')`"
bibliography: references.bib  
---


```{r global-options, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = F,
  message = F,
  warning = F,
  fig.height = 4,
  fig.align = 'center',
  dpi = 400,
  cache = T
)
```

```{r libraries}
library(tidyverse)
library(rstanarm)
library(tidybayes)
library(cmdstanr)
library(rms)
library(posterior)
library(rsample)
library(duckdb)
library(DBI)
source('R/utils.R')

theme_set(theme_light())
cmdstanr::register_knitr_engine(override = F)
```

```{r load-data}
con = dbConnect(duckdb(),'data/database/apixaban_data.duckdb')
d = tbl(con, 'ute_scaled_cleaned_data') %>% 
    collect()

dbDisconnect(con)
```

# Introduction

Apixaban is a direct acting oral anti-coagulant often prescribed for prevention of stroke and systemic embolism in patients with atrial fibrillation (AF) [-@BMSmonograph; -@byon2019apixaban].  Studies as recent as 2019 have reported excess variability in observed apixaban plasma concentrations in patients with AF [-@sukumar2019apixaban]. Since apixaban plasma concentrations correlate closely with anti-coagulation[-@upreti2013effect,-@frost2013safety,-@frost2013apixaban], excess variability in these concentrations may mean increased risk of bleeding. These findings raise questions towards the optimal dosing of apixaban in older adults with AF encountered outside of clinical trials.

These findings have also spurred additional research into determining factors which explain this excess variability beyond known clinical factors [-@gulilat2020drug].  Models presented in this research consider the effect of covariates $(\mathbf{x})$, as well as time $(t)$, to be linear on the log concentration $(\log(y))$ scale.  The models are then

$$ \log(y) = \beta_t  t + \mathbf{x} \beta + \varepsilon\>. $$
\noindent Here $\varepsilon$ is observational noise on the log scale with mean 0 and finite variance $\sigma^2$.

Log-linear models can be useful when the pharmacokinetics in the elimination phase are approximately exponential (as would be the case in a first order elimination compartmental model).  However, their usefulness in estimating effects of various factors on plasma concentrations for use in downstream decision making for dose size is questionable under three important limitations:

1) Log-linear models as presented in [@gulilat2020drug] a single parameter for the effect of time on log plasma concentrations.  The consequence is that all patients -- regardless of clinical factors -- are given the same elimination rate despite it being known that elimination of apixaban is modulated by clinical factors, such as renal function **CITATION**.  Elimination partly determines trough concentrations, and use of log-linear models to make decusions which are functions of trough concentration (e.g. prescribe a dose so that there is some acceptable risk of exceeding some trough concentration threshold) can be effected.  This problem can be avoided by allowing interactions between time and known modulators of elimination rate, but estimates may suffer from low precision.

2) Due to the linear effect of time, estimates of max concentration suffer from an upward bias.  This bias persists even when time to max concentration is known exactly (which is never the case).  This bias can be small when time to max concentration is large, but can be large when time to max concentration is small.  If decisions on dose are to be made as a function of max concentration (e.g. prescribe a dose so that there is some acceptable risk of exceeding some concentration threshold), use log-linear models can effect decision quality in an appreciable way.


3) The interpretation of the coefficients for covariates aside from time, $\beta$, represent the change in expected log concentration due to a unit change in the associated covariate.  However, where this change manifests in the pharmacokinetics is is underdetermined.  For example, [@gulilat2020drug] identified concomitant amiodarone is associated with an increase in log-concentrations.  Could this be because an increase in bio availability, or a decrease in clearance, or some other reason?


All of these limitations can be ameliorated, if not completely avoided, by modelling the pharmacokientics directly using population pharmacokientic (popPK) models.  PopPK models allow users to specify which covariates effect which aspects of the pharmacokientcs directly, resolving issues 1 and 3.  Additionally, modelling the time evolution of the concentration using a compartmental model may reduce bias in estimation of max concentration, resolving issue 2.  However, fitting popPK models usually requires access to proporiety software such as NONMEM **CITATION** or monplix **CITATION**, which can be prohibitive.

This paper presents a Bayesian popPK model written in an open source Bayesian language.  We choose an open source language to make results widely available to investigators, and we choose a Bayesian approach to demonstrate how these models can be used in decision making processes regarding dose.  Our model is fit using 401 observations of apixaban concentrations collected from patients in London, Ontario seeing a personalized medicine clinic.  We supplement these data with data from a highly controlled experiment on pharmacokinetics